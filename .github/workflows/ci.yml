name: Build
on:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Set up Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: 3.7
    - uses: actions/cache@v2
      name: Cache dependencies
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements_dev.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Install some extras
      run: |
        git clone https://github.com/IATI/IATI-Developer-Documentation.git
        git clone https://github.com/IATI/IATI-Guidance.git

        git clone --branch version-2.03 https://github.com/IATI/IATI-Codelists.git
        git clone --branch version-2.03 https://github.com/IATI/IATI-Extra-Documentation.git
        cd IATI-Extra-Documentation
        git reset --hard 84bcc7bd
        cd ..
        git clone --branch version-2.03 https://github.com/IATI/IATI-Rulesets.git
        git clone --branch version-2.03 https://github.com/IATI/IATI-Schemas.git
        git clone --branch rel-path-to-assets https://github.com/andylolz/IATI-Websites.git

        cd IATI-Extra-Documentation/en
        ln -s ../../IATI-Websites/iatistandard/_templates/ ./
        ln -s ../../IATI-Websites/iatistandard/_static/ ./
        cd ../..
        ln -s IATI-Rulesets/iatirulesets ./
        mkdir docs
    - name: Build
      run: ./combined_gen.sh
    - name: Add a nojekyll file
      run: touch docs/en/_build/dirhtml/.nojekyll
    - name: Deploy ðŸš€
      uses: JamesIves/github-pages-deploy-action@3.7.1
      with:
        GIT_CONFIG_NAME: Code for IATI bot
        GIT_CONFIG_EMAIL: 57559326+codeforIATIbot@users.noreply.github.com
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
        BRANCH: gh-pages
        FOLDER: docs/en/_build/dirhtml
        CLEAN: true
